# 8) 동작 규칙 / 충돌 규칙

## 개요

다양한 UX 패턴과 설정 옵션들이 조합될 때 발생할 수 있는 충돌을 방지하고, 일관된 동작을 보장하기 위한 규칙들을 정의한다.

---

## 8.1 UX 패턴 조합 규칙

### 8.1.1 권장 조합

#### 조합 1: Entry Modal + Inline Blur Gate
- **설명**: 모달에서 첫 번째 유도, 인라인에서 두 번째 유도 (강한 전환)
- **동작**:
  - 페이지 진입 시 Entry Modal 표시
  - 사용자가 모달에서 폼 제출 → 모달 닫힘, 블라인드 해제
  - 사용자가 콘텐츠를 읽다가 Inline Blur Gate 구간 도달
  - 이미 unlocked 상태이므로 블러가 해제된 상태로 표시 (또는 운영자 설정에 따라 별도 동작)
- **권장 사용 시나리오**: 중요한 콘텐츠, 높은 전환율 목표

#### 조합 2: Top/Bottom Form + Inline Blur Gate
- **설명**: 상/하단은 약한 유도, 인라인은 강한 락
- **동작**:
  - 상단/하단 폼은 콘텐츠 흐름을 방해하지 않으면서 폼 제출 유도
  - 사용자가 폼을 제출하지 않고 계속 읽으면 Inline Blur Gate 구간에서 막힘
  - Inline Blur Gate에서 폼 제출 필수
- **권장 사용 시나리오**: 긴 콘텐츠, 단계적 유도

#### 조합 3: Floating CTA만 단독
- **설명**: 가장 덜 방해하는 방식
- **동작**:
  - 우측 하단 CTA 버튼만 표시
  - 사용자가 자유롭게 콘텐츠를 읽을 수 있음
  - 필요 시 버튼 클릭하여 폼 제출
- **권장 사용 시나리오**: 자유롭게 읽히길 원하는 콘텐츠, 블로그 글

#### 조합 4: Top Form + Bottom Form
- **설명**: 상단과 하단에 각각 폼 배치
- **동작**:
  - 상단 폼과 하단 폼 모두 표시
  - 각각 독립적으로 동작
  - 어느 쪽을 제출해도 블라인드 해제
- **권장 사용 시나리오**: 긴 콘텐츠, 여러 기회 제공

---

### 8.1.2 충돌 조합 및 해결 규칙

#### 충돌 1: Entry Modal + Top/Bottom Form
- **문제**: Entry Modal과 Top/Bottom Form이 동시에 표시되면 사용자 경험이 나쁨
- **해결 규칙**: 
  - Entry Modal이 있으면 Top/Bottom Form은 표시하지 않음
  - Entry Modal이 닫힌 후에도 Top/Bottom Form은 표시하지 않음
  - 운영자 설정 시 경고 메시지: "Entry 모달이 있으면 상/하단 폼은 표시되지 않습니다. 계속하시겠어요?"
  - 사용자가 확인하면 Top/Bottom Form 설정은 저장되지만 동작하지 않음

#### 충돌 2: 여러 Inline Blur Gate
- **문제**: MVP에서는 1개의 블러 구간만 지원
- **해결 규칙**:
  - 여러 개 선택 시 경고: "현재는 1개의 블러 구간만 지원합니다."
  - 첫 번째로 선택한 것만 유효
  - 나머지는 무시

#### 충돌 3: 모든 패턴 OFF
- **문제**: UX 패턴이 하나도 선택되지 않으면 리드를 수집할 방법이 없음
- **해결 규칙**:
  - 최소 1개는 선택해야 함
  - 검증 에러: "최소 1개의 UX 패턴을 선택해 주세요."
  - "Next" 버튼 비활성화

---

### 8.1.3 패턴 우선순위 규칙

#### 우선순위 순서 (높은 순서대로)
1. **Entry Modal** (최우선)
   - Entry Modal이 있으면 다른 패턴과 동시 표시하지 않음
   - Entry Modal이 닫힌 후에도 Top/Bottom Form은 표시하지 않음
   
2. **Inline Blur Gate**
   - 블러 구간에 도달했을 때 표시
   - 다른 패턴과 공존 가능 (Entry Modal 제외)
   
3. **Top/Bottom Form**
   - Entry Modal이 없을 때만 표시
   - Inline Blur Gate와 공존 가능
   
4. **Floating CTA**
   - 항상 표시 가능 (다른 패턴과 공존)
   - Entry Modal이 표시되어도 배경에 버튼은 보일 수 있으나, 클릭은 Entry Modal이 닫힌 후에만 가능

---

## 8.2 "이미 해제된 사용자" 규칙

### 8.2.1 unlocked 상태 확인

#### 확인 방법
- localStorage에서 `unlocked_{project_id}` 확인
- 쿠키에서 `unlocked_{project_id}` 확인
- 만료 시간 확인 (운영자 설정: 세션/7일/30일)

#### 확인 시점
- 페이지 로드 시
- 폼 제출 전
- 스크롤하여 블러 구간 도달 시

---

### 8.2.2 unlocked 상태일 때 동작

#### 블라인드 처리
- **블라인드 제거**: 모든 블러 효과 제거, 콘텐츠가 선명하게 표시
- **애니메이션**: 필요 시 부드러운 전환 효과 (페이드인)

#### 폼/모달 표시
- **Entry Modal**: 표시하지 않음
- **Top/Bottom Form**: 숨김 (기본) 또는 "Unlocked" 배지 표시 (운영자 설정)
- **Inline Blur Gate**: 인라인 카드 제거, 블러 해제
- **Floating CTA**: 숨김 (기본) 또는 "Unlocked" 배지 표시 (운영자 설정)

#### 사용자 피드백
- **상단 작은 배지** (선택): "Unlocked on this device"
- **또는**: 폼/모달이 아예 표시되지 않음

---

### 8.2.3 unlocked 상태 유지 기간

#### 기본값
- 30일 (운영자 설정 가능)

#### 만료 처리
- 만료 시간이 지나면 unlocked 상태 해제
- 처음 방문과 동일하게 처리
- 폼을 다시 제출해야 함

#### 세션 기반 유지
- 운영자가 "세션만" 선택 시:
  - 브라우저를 닫으면 unlocked 상태 해제
  - 다음 방문 시 다시 폼 제출 필요

---

## 8.3 개인정보/동의 규칙

### 8.3.1 개인정보 처리 동의

#### 기본 설정
- **기본값**: 필수 (권장)
- **운영자 설정**: 필수/선택 토글 가능

#### 필수인 경우
- 체크박스가 필수로 표시됨
- 체크하지 않으면 폼 제출 불가
- 에러 메시지: "개인정보 처리에 동의해 주세요."

#### 선택인 경우
- 체크박스가 선택 사항으로 표시됨
- 체크하지 않아도 폼 제출 가능
- 단, 운영자에게는 동의 여부가 기록됨

---

### 8.3.2 마케팅 수신 동의

#### 기본 설정
- **기본값**: OFF (선택)
- **운영자 설정**: ON/OFF 가능

#### OFF인 경우
- 체크박스가 표시되지 않음
- 리드 데이터에 `consent_marketing: false` 저장

#### ON인 경우
- 체크박스가 선택 사항으로 표시됨
- 체크하지 않아도 폼 제출 가능
- 리드 데이터에 체크 여부 저장 (`consent_marketing: true/false`)

---

### 8.3.3 동의 데이터 저장

#### 저장 항목
- `consent_privacy`: boolean (개인정보 처리 동의)
- `consent_marketing`: boolean (마케팅 수신 동의)
- `consented_at`: timestamp (동의 시각)

#### 활용
- 마케팅 수신 동의한 사용자만 이메일 발송
- 개인정보 처리 동의는 법적 요구사항 준수

---

## 8.4 블라인드 해제 규칙

### 8.4.1 해제 조건

#### 필수 조건
- 폼 제출 성공
- 모든 필수 필드 입력 완료
- 유효성 검사 통과
- 개인정보 처리 동의 (필수인 경우)

---

### 8.4.2 해제 동작

#### 즉시 해제
- 폼 제출 성공 시 즉시 블라인드 해제
- 애니메이션 효과: 블러가 사라지는 효과 (0.3-0.5초)

#### 해제 범위
- 모든 블러 구간 해제
- Inline Blur Gate의 인라인 카드 제거
- Entry Modal 닫기
- Top/Bottom Form은 유지하되 "Unlocked" 표시 (또는 숨김)

---

### 8.4.3 해제 실패 처리

#### 네트워크 오류
- 블라인드는 해제하지 않음
- 에러 메시지 표시
- 재시도 가능

#### 서버 오류
- 블라인드는 해제하지 않음
- 에러 메시지 표시
- 재시도 가능

#### 유효성 검사 실패
- 블라인드는 해제하지 않음
- 필드별 에러 메시지 표시
- 수정 후 재제출 가능

---

## 8.5 폼 제출 규칙

### 8.5.1 중복 제출 방지

#### 클라이언트 측
- 제출 버튼 클릭 시 즉시 비활성화
- 제출 중 표시: "제출 중..." 또는 로딩 스피너
- 제출 완료까지 버튼 비활성화 유지

#### 서버 측
- Rate limiting: IP당 분당 N회 제한 (예: 10회)
- 중복 제출 검증: 동일 이메일 + 프로젝트 ID 조합
- 중복 제출 정책 (운영자 설정):
  - 업데이트: 기존 리드 업데이트
  - 무시: 기존 리드 유지, 새 리드 무시

---

### 8.5.2 제출 데이터 검증

#### 필수 필드
- 이메일: 반드시 입력, 유효한 이메일 형식
- 개인정보 처리 동의: 필수인 경우 체크 필수

#### 선택 필드
- 이름, 회사명, 직무, 한 줄 질문: 선택 사항
- 입력하지 않으면 빈 문자열 또는 null 저장

#### 유효성 검사
- 이메일 형식: RFC 5322 기준 (간단한 정규식 사용)
- 필드 길이: 최대 길이 제한 (예: 이름 100자, 한 줄 질문 500자)
- 특수 문자: XSS 방지를 위한 이스케이프 처리

---

## 8.6 상태 저장 규칙

### 8.6.1 저장 방식 우선순위

#### 1순위: localStorage
- `localStorage.setItem('unlocked_{project_id}', 'true')`
- `localStorage.setItem('unlocked_at_{project_id}', timestamp)`
- 만료 시간도 함께 저장

#### 2순위: Cookie (localStorage 실패 시)
- `document.cookie = 'unlocked_{project_id}=true; expires=...'`
- 만료 시간 설정

#### 3순위: Session (둘 다 실패 시)
- 브라우저 세션 동안만 유지
- 브라우저 닫으면 해제

---

### 8.6.2 저장 데이터 형식

#### localStorage
```javascript
{
  'unlocked_{project_id}': 'true',
  'unlocked_at_{project_id}': '1234567890',
  'unlock_expires_{project_id}': '1234567890' // timestamp
}
```

#### Cookie
```
unlocked_{project_id}=true; expires=Wed, 31 Jan 2024 23:59:59 GMT; path=/
```

---

## 8.7 에러 처리 규칙

### 8.7.1 클라이언트 에러

#### 네트워크 에러
- 에러 메시지: "네트워크가 불안정해요. 한 번만 더."
- 재시도 버튼 표시
- 최대 2회 재시도

#### 유효성 검사 에러
- 필드별 에러 메시지 표시
- 필드 테두리를 빨간색으로 변경
- 스크롤하여 해당 필드로 이동

---

### 8.7.2 서버 에러

#### 500 에러
- 에러 메시지: "잠시 오류가 있었어요. 다시 시도해 주세요."
- 재시도 버튼 표시

#### 400 에러 (잘못된 요청)
- 에러 메시지: "입력한 정보를 확인해 주세요."
- 필드별 에러 상세 메시지 표시

#### 429 에러 (Rate Limit)
- 에러 메시지: "너무 많이 요청했어요. 잠시 후 다시 시도해 주세요."
- 재시도 버튼은 일정 시간 후 활성화

---

## 8.8 키워드 블랙아웃 폴백 규칙

### 8.8.1 폴백 조건

#### 초기 로드 시 검증
- iframe 로드 완료 후 키워드 블랙아웃 시도
- 실패하면 즉시 Section Blur로 전환

#### 부분 실패
- 일부 키워드만 찾지 못한 경우: 찾은 키워드만 블랙아웃
- 모든 키워드를 찾지 못한 경우: Section Blur로 전환

---

### 8.8.2 폴백 처리

#### 자동 전환
- 사용자에게 별도 알림 없이 자동으로 Section Blur 적용
- 운영자 콘솔에 "blackout_failed" 로그 기록

#### 사용자 경험
- 사용자는 블라인드가 적용된 것은 확인할 수 있으나, 방식의 차이는 느끼기 어려움
- 폼 제출 및 해제 동작은 동일

---

## 8.9 모바일/PC 별도 설정 규칙

### 8.9.1 설정 우선순위

#### 별도 설정 OFF (기본)
- 모바일/PC 동일한 설정 사용
- 운영자가 설정한 값이 모든 디바이스에 적용

#### 별도 설정 ON
- User-Agent 또는 화면 너비로 디바이스 구분
- 모바일 설정과 PC 설정을 각각 저장
- 각 디바이스에 맞는 설정 적용

---

### 8.9.2 디바이스 구분

#### 모바일
- 화면 너비 < 768px (또는 User-Agent 기반)
- 터치 디바이스 감지

#### PC
- 화면 너비 >= 768px (또는 User-Agent 기반)
- 마우스/키보드 입력

---

## 8.10 UTM 파라미터 처리 규칙

### 8.10.1 파라미터 보존

#### 자동 보존
- 공유 링크에 포함된 UTM 파라미터는 자동으로 보존
- 리드 데이터에 `source_utm` 필드로 저장

#### 파라미터 형식
```json
{
  "utm_source": "linkedin",
  "utm_medium": "social",
  "utm_campaign": "template_2024",
  "utm_term": "optional",
  "utm_content": "optional"
}
```

---

### 8.10.2 자동 추가 (고급설정)

#### 운영자 설정
- UTM 파라미터 자동 추가 ON/OFF
- utm_source, utm_medium, utm_campaign 설정

#### 동작
- 공유 링크에 운영자가 설정한 UTM 파라미터 자동 추가
- 기존 파라미터가 있으면 병합 (운영자 설정 우선)

---

## 8.11 최종 규칙 요약

### 핵심 원칙
1. **사용자 경험 우선**: 충돌이 발생하면 사용자 경험이 좋은 방향으로 결정
2. **명확한 우선순위**: 패턴별 명확한 우선순위 규칙 적용
3. **자동 폴백**: 실패 시 자동으로 대체 방법 적용
4. **투명한 에러 처리**: 사용자에게 명확한 에러 메시지 제공
5. **유연한 설정**: 운영자가 필요한 옵션을 조절할 수 있도록 제공






