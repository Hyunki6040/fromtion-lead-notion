# 14) 엣지 케이스 & 폴백

## 개요

예상되는 엣지 케이스와 각 경우에 대한 처리 방안을 정의한다. 사용자 경험을 저해하지 않으면서 안정적으로 작동하도록 한다.

---

## 14.1 Notion 관련 엣지 케이스

### 14.1.1 Notion URL 비공개/권한 없음

#### 시나리오
- 운영자가 비공개 Notion 링크를 입력
- 또는 공개 링크가 아니지만 임베드 시도

#### 처리 방안
1. **프리뷰 단계에서 차단**
   - "Load preview" 버튼 클릭 시 에러 발생
   - 에러 메시지: "이 링크는 공개 공유가 아니에요. Notion에서 '공개'로 바꿔주세요."
   - 해결 방법 안내: "Notion 페이지 우측 상단 '공유' 버튼 → '웹에 공개' 활성화"

2. **이미 저장된 프로젝트**
   - 공개 링크가 나중에 비공개로 변경된 경우
   - 공유 화면에서 로딩 실패
   - 에러 메시지: "콘텐츠를 불러올 수 없어요. Notion 페이지가 공개 공유로 설정되어 있는지 확인해 주세요."

#### 기술적 구현
```javascript
function checkNotionAccess(url) {
  return fetch(url, { method: 'HEAD', mode: 'no-cors' })
    .then(() => true)
    .catch(() => false);
}
```

---

### 14.1.2 Notion 레이아웃 변경

#### 시나리오
- Notion이 DOM 구조를 변경하여 블러 구간 위치가 틀어짐
- 섹션 블러 위치가 콘텐츠와 맞지 않음

#### 처리 방안
1. **간단 모드 (프리셋) 내구성 강화**
   - 퍼센트 기반 위치 지정 (픽셀보다 안정적)
   - 프리셋 (초반/중간/하단) 사용 권장

2. **고급 모드 (직접 지정)**
   - 드래그로 오버레이 영역 재조정 UI (MVP 후순위)
   - 현재는 프리셋 사용 권장

3. **사용자 안내**
   - 운영자에게 "Notion 레이아웃이 변경되면 블러 위치를 다시 조정해야 할 수 있어요" 안내

---

### 14.1.3 Notion 콘텐츠 로딩 실패

#### 시나리오
- 네트워크 오류
- Notion 서버 오류
- 타임아웃

#### 처리 방안
1. **재시도 로직**
   - 자동 재시도 (최대 3회, 지수 백오프)
   - 재시도 중 로딩 스피너 표시

2. **에러 메시지**
   - "콘텐츠를 불러오는 중 문제가 발생했어요. 잠시 후 다시 시도해 주세요."
   - "새로고침" 버튼 제공

3. **타임아웃**
   - 30초 타임아웃 설정
   - 타임아웃 시 에러 메시지 표시

---

## 14.2 브라우저/환경 관련 엣지 케이스

### 14.2.1 Cookie 차단 환경

#### 시나리오
- 사용자가 쿠키를 차단
- localStorage도 사용 불가능한 경우

#### 처리 방안
1. **localStorage 우선 사용**
   - localStorage를 먼저 시도
   - 실패 시 쿠키 사용

2. **둘 다 막힌 경우**
   - 세션 기반으로만 유지 (브라우저 닫으면 해제)
   - 사용자에게 안내: "이 브라우저 설정에서는 재방문 시 다시 입력이 필요할 수 있어요." (선택, 사용자 경험 저해 최소화)

3. **Graceful Degradation**
   - 기능은 정상 작동 (폼 제출, 블라인드 해제)
   - 단지 재방문 시 상태 유지가 안 됨

---

### 14.2.2 구형 브라우저

#### 시나리오
- CSS `backdrop-filter` 미지원 (IE, 구형 Safari)
- ES6+ 문법 미지원

#### 처리 방안
1. **CSS 폴백**
   - `backdrop-filter` 실패 시 `filter` 사용
   - 둘 다 실패 시 어둡게만 처리 (블러 없이)

2. **JavaScript 폴백**
   - Babel로 트랜스파일 (ES5 호환)
   - 또는 Polyfill 사용

3. **브라우저 지원 정책**
   - MVP에서는 최신 브라우저 우선 지원
   - 구형 브라우저는 기본 기능만 작동

---

### 14.2.3 모바일 Safari 특수 동작

#### 시나리오
- iOS Safari에서 `position: fixed` 이슈
- 키보드가 올라올 때 레이아웃 깨짐
- 스크롤 동작 차이

#### 처리 방안
1. **Fixed Position 처리**
   - `-webkit-transform: translateZ(0)` 사용
   - 또는 JavaScript로 위치 조정

2. **키보드 처리**
   - `visualViewport` API 사용 (지원되는 경우)
   - 키보드 올라올 때 모달/Drawer 위치 조정

3. **스크롤 처리**
   - `-webkit-overflow-scrolling: touch` 사용
   - 스크롤 이벤트 최적화

---

### 14.2.4 시크릿 모드/프라이빗 브라우징

#### 시나리오
- localStorage 사용 제한
- 쿠키 사용 제한

#### 처리 방안
- Cookie 차단 환경과 동일하게 처리
- 세션 기반으로만 유지

---

## 14.3 폼 제출 관련 엣지 케이스

### 14.3.1 네트워크 오류

#### 시나리오
- 폼 제출 중 네트워크 연결 끊김
- 서버 응답 없음

#### 처리 방안
1. **에러 메시지**
   - "네트워크가 불안정해요. 한 번만 더."
   - 재시도 버튼 표시

2. **재시도 로직**
   - 최대 2회 재시도
   - 지수 백오프 (1초, 2초)

3. **상태 관리**
   - 제출 실패 시 블라인드는 해제하지 않음
   - 폼 데이터는 유지 (사용자가 다시 제출 가능)

---

### 14.3.2 서버 오류 (500)

#### 시나리오
- 서버 내부 오류
- 데이터베이스 오류

#### 처리 방안
1. **에러 메시지**
   - "잠시 오류가 있었어요. 다시 시도해 주세요."
   - 재시도 버튼 표시

2. **로깅**
   - 서버 에러 로그 기록
   - 운영자에게 알림 (선택)

3. **사용자 경험**
   - 블라인드는 해제하지 않음
   - 폼 데이터는 유지

---

### 14.3.3 중복 제출

#### 시나리오
- 사용자가 제출 버튼을 여러 번 클릭
- 네트워크 지연으로 인한 중복 요청

#### 처리 방안
1. **클라이언트 측 방지**
   - 제출 버튼 즉시 비활성화
   - 제출 중 표시 ("제출 중...")

2. **서버 측 처리**
   - `dedupe_key` 기반 중복 검증
   - 중복 제출 정책 적용 (업데이트 또는 무시)

---

### 14.3.4 유효성 검사 실패

#### 시나리오
- 필수 필드 미입력
- 이메일 형식 오류

#### 처리 방안
1. **실시간 검증**
   - 입력 중 실시간 피드백
   - 필드별 에러 메시지

2. **제출 시 검증**
   - 모든 필드 검증
   - 에러가 있는 필드로 스크롤
   - 에러 메시지 표시

---

## 14.4 키워드 블랙아웃 관련 엣지 케이스

### 14.4.1 Keyword Blackout 실패

#### 시나리오
- CORS 에러로 iframe 접근 불가
- Notion DOM 구조 변경으로 키워드를 찾을 수 없음

#### 처리 방안
1. **자동 폴백**
   - 실패 시 즉시 Section Blur로 전환
   - 사용자에게 별도 알림 없음 (자동 처리)

2. **운영자 알림**
   - 운영자 콘솔에 "blackout_failed" 로그 기록
   - 필요 시 이메일 알림 (선택)

3. **에러 타입별 처리**
   - CORS 에러: 즉시 폴백
   - 키워드 못 찾음: 찾은 키워드만 블랙아웃 또는 전체 폴백

---

### 14.4.2 키워드가 너무 많음

#### 시나리오
- 운영자가 수백 개의 키워드를 입력
- 성능 저하

#### 처리 방안
1. **제한 설정**
   - 최대 키워드 개수 제한 (예: 50개)
   - 초과 시 경고 메시지

2. **성능 최적화**
   - 키워드 검색 최적화 (정규식 컴파일 등)
   - 필요 시 배치 처리

---

## 14.5 상태 저장 관련 엣지 케이스

### 14.5.1 localStorage 용량 초과

#### 시나리오
- 브라우저별 localStorage 용량 제한 (보통 5-10MB)
- 여러 프로젝트의 unlocked 상태를 저장하다가 용량 초과

#### 처리 방안
1. **용량 관리**
   - 오래된 unlocked 상태 정리 (만료된 것 삭제)
   - 최대 저장 개수 제한

2. **에러 처리**
   - 저장 실패 시 쿠키로 폴백
   - 둘 다 실패 시 세션만 유지

---

### 14.5.2 만료 시간 처리

#### 시나리오
- 만료 시간이 지난 unlocked 상태
- 사용자가 재방문

#### 처리 방안
1. **만료 확인**
   - 페이지 로드 시 만료 시간 확인
   - 만료되었으면 unlocked 상태 해제

2. **사용자 경험**
   - 처음 방문과 동일하게 처리
   - 폼을 다시 제출해야 함

---

## 14.6 운영자 관련 엣지 케이스

### 14.6.1 공유 링크 슬러그 중복

#### 시나리오
- 운영자가 이미 사용 중인 슬러그 입력
- 또는 자동 생성된 슬러그가 중복

#### 처리 방안
1. **중복 검증**
   - 입력 중 실시간 검증
   - 저장 시 서버 측 검증

2. **에러 메시지**
   - "이미 사용 중인 경로예요. 다른 이름을 입력해 주세요."
   - 사용 가능한 대안 제시 (예: "abc123-1")

3. **자동 생성**
   - 자동 생성 시 중복 방지 로직 (랜덤 문자열, 타임스탬프 추가 등)

---

### 14.6.2 프로젝트 삭제

#### 시나리오
- 운영자가 프로젝트 삭제
- 이미 공유된 링크 접속

#### 처리 방안
1. **Soft Delete**
   - 프로젝트를 완전히 삭제하지 않고 `deleted_at` 필드만 설정
   - 30일 후 영구 삭제 (선택)

2. **공유 화면 처리**
   - 삭제된 프로젝트는 공유 화면에서 접근 불가
   - 에러 메시지: "이 콘텐츠는 더 이상 사용할 수 없어요."

---

## 14.7 데이터 관련 엣지 케이스

### 14.7.1 대량 리드 수집

#### 시나리오
- 한 프로젝트에 수천 개의 리드가 쌓임
- 리드 목록 조회 성능 저하

#### 처리 방안
1. **페이지네이션**
   - 리드 목록은 페이지네이션으로 표시 (기본 50개)
   - 필요 시 페이지 크기 조절

2. **인덱스 최적화**
   - 데이터베이스 인덱스 설정
   - 검색 쿼리 최적화

---

### 14.7.2 데이터베이스 용량

#### 시나리오
- 리드 데이터가 계속 쌓여서 데이터베이스 용량 초과

#### 처리 방안
1. **데이터 보관 정책**
   - 프로젝트 삭제 시 관련 리드도 삭제
   - 또는 자동 아카이빙 (추후)

2. **모니터링**
   - 데이터베이스 용량 모니터링
   - 임계값 도달 시 알림

---

## 14.8 폴백 전략 요약

### 14.8.1 계층적 폴백

```
Keyword Blackout 시도
  ↓ 실패
Section Blur로 전환
  ↓ (항상 성공, 안정적)
정상 작동
```

```
localStorage 저장 시도
  ↓ 실패
Cookie로 전환
  ↓ 실패
세션만 유지
  ↓ (기능은 작동, 재방문 시 상태 유지 안 됨)
```

### 14.8.2 Graceful Degradation 원칙

1. **핵심 기능 우선**: 폼 제출, 블라인드 해제는 항상 작동
2. **부가 기능 폴백**: 재방문 상태 유지 등은 실패해도 핵심 기능은 유지
3. **사용자 안내 최소화**: 기술적인 문제는 자동으로 처리, 사용자에게는 최소한의 안내만

---

## 14.9 엣지 케이스 대응 체크리스트

### 개발 단계
- [ ] Notion URL 검증 및 에러 처리
- [ ] 네트워크 오류 처리
- [ ] 브라우저 호환성 테스트
- [ ] 모바일 Safari 테스트
- [ ] Cookie/localStorage 차단 환경 테스트
- [ ] 중복 제출 방지
- [ ] 키워드 블랙아웃 폴백 테스트

### 배포 전
- [ ] 모든 엣지 케이스 시나리오 테스트
- [ ] 에러 메시지 검토
- [ ] 사용자 안내 문구 검토
- [ ] 성능 테스트 (대량 데이터)






